(function(n){n.fn.userSelect=function(t){n.fn.userSelect.defaults={mapping:"",columns:"工号:Code,姓名:Name",postpara:"",ajaxsrc:_PORTALROOT_GLOBAL+"/Ajax/GetSirio2015.ashx?method=GetUserInfo",serchtitle:"&nbsp;&nbsp;查找："};var r=n.extend({},n.fn.userSelect.defaults,t),i;return this.each(function(){var t=n(this);if(t.attr("readonly")!="readonly"){t.on("click",function(t){t.preventDefault();t.stopPropagation();n(".userSelect")[0]&&n(".userSelect").remove();var i=n(this).height(),r=n(this).width()<250?250:n(this).width(),u=n(this).offset().top+i+7,e=n(this).offset().left;f(e,u,r)});var f=function(t,i,u){var f=['<div class="userSelect" id="test" style="border:1px solid #e4e4e4;background-color:#FFFFFF;position:absolute;left:'+t+"px;top:"+i+"px;width:"+u+'px;z-index:99999">','<form class="form-inline">','<div class="form-group has-feedback"><label for="txtSearchKey" class="control-label">'+r.serchtitle+'<\/label><input id="txtSearchKey" placeholder="支持模糊查询" class="form-control" type="text"/>','<span class="fa fa-search form-control-feedback"><\/span><\/div>',"<\/form>",'<div style="height:220px;overflow-x:hidden;overflow-y:auto;width:100%">','<table class="table table-hover scrollTable selecttb" id="tbSelectWord">',"<\/table><\/div><\/div>"].join("");n(".userSelect")&&n(".userSelect").length==0?(n("body").append(f),o(s)):n(".userSelect").is(":visible")||n(".userSelect").fadeIn(100)},e=function(u){var v,c,e,h,p,a,s,w;if(r.mapping!=""){for(v=n(u).attr("dataindex"),result=i[v],c=r.mapping.split(","),h=0;h<c.length;h++)if((e=c[h].split(":"),e.length==2)&&result[e[1]]!=null){var y=result[e[1]],f=e[0],o,b=n(t).find("input[datafield='"+f+"'],textarea[datafield='"+f+"'],select[datafield='"+f+"'],input[data-datafield='"+f+"'],textarea[data-datafield='"+f+"'],select[data-datafield='"+f+"']").eq(0),l=n(b).attr("id");l!=null?n("#"+l)!=null&&(o=n("#"+l)):n("#"+e[0])!=null&&n("#"+e[0]).length>0?o=n("#"+e[0]):(p=n(t).parent().parent(),a=p.find("input[datafield='"+f+"'],textarea[datafield='"+f+"'],select[datafield='"+f+"'],input[data-datafield='"+f+"'],textarea[data-datafield='"+f+"'],select[data-datafield='"+f+"']"),a.length>0&&(o=a));o&&(o.val(y),y&&t.SheetUIManager().RemoveInvalidText(o[0]))}n(u).focus();n(u).change();s=t.SheetUIManager();s&&s.OnChange&&s.RunScript(t[0],s.OnChange);n("#txtSearchKey").val("");n(".userSelect").hide();return}w=n(u).find("td").eq(0).text();t.val(w)},o=function(t){var f=eval(r.postpara);n.ajax({url:r.ajaxsrc,type:"post",dataType:"json",data:f[0],success:function(n){n!=null&&(n=eval(n),i=n,u());typeof t=="function"&&t&&t()}})},u=function(){var o,s,u,c,h;if(i){var l=n.trim(n("#txtSearchKey").val()),f=r.columns.split(","),t="";for(t+="<thead><tr>",o=0;o<f.length;o++)s=f[o].split(":"),t+="<th>"+s[0]+"<\/th>";for(t+="<\/tr><\/thead>",u=0;u<i.length;u++)if(!(l.length>0)||!(JSON.stringify(i[u]).indexOf(l)<0)){for(c=JSON.stringify(i[u]),c=c.replace(/"/g,"'"),t+="<tr dataindex = '"+u+"'>",h=0;h<f.length;h++)s=f[h].split(":"),t+="<td>"+i[u][s[1]]+"<\/td>";t+="<\/tr>"}n(".selecttb").html(t);n(".userSelect").find("tr").on("click",function(t){t.preventDefault();t.stopPropagation();e(this);n(".userSelect").hide()})}},s=function(){if(n(".userSelect").is(":visible")){n(".userSelect").find("button").bind("click",function(){n(".userSelect").hide()});n("#txtSearchKey").on("input propertychange",function(){u()});n(document).on("click",function(t){for(var r=t||window.event,i=r.target||r.srcElement;i;){if(i.className&&i.className=="userSelect")return;i=i.parentNode}n(".userSelect").remove()})}}}})}})(jQuery);